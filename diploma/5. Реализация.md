## 5.1. Выбор технологий

Технологический стек:
- Java
- Kotlin (JVM)
- Maven
- Ant
- bigbone
- JUnit 
- Gson

В качестве языка реализации было принято решение использовать Kotlin. Этому способствовали следующие причины:
1. Язык Kotlin имеет полную функциональную совместимость с Java, на которой написана платформа Luwrain.
2. Являясь достаточно современным языком, Kotlin является более выразительным и надежным выбором для решения различного рода задач. Это позволяет решать те же задачи, которые решает язык Java, но требует меньше усилий.
3. Одним наиболее значимых преимуществ языка Kotlin - это nullability на уровне типов. Другими словами, язык позволяет указывать, какие переменные могут принимать значение null, а какие нет. Это позволяет еще на этапе компиляции определять и устранять места, в которых возможно обращение к null объекту, а следовательно избежать очень большого количества NullPointerException, которое является одним из наиболее часто встрещающихся искоючений, возникающих при использовании языка Java. Это помогает сэкономить много времени на отладку, особенно при работе с интернет ресурсами.
4. Интеграция приложения на этом языке позволит облегчить дальнейшее использование этого языка в приложениях для платформы Luwrain, для этого необходимо внести изменения в процесс компиляции, так как ранее он не использовался.

Исходный код платформы Luwrain на данный момент собирается при помощи двух систем сборки: Apache Maven и Apache Ant. Файлы для сборки приложений генерируются автоматически, поэтому было принято решение воспользоваться этими технологиями, несмотря на то, что процесс разработки и компиляции (сборки) повлечет некоторые изменения (со стороны исходного кода платформы), хоть и не большие.

Mastodon обладает отличной документацией, подробно описывающей API со всеми параметрами для запросов и кодами возможных ошибок с пояснениями. При создании клиента для такого API всегда есть два подхода: 
1. Выбрать необходимые пути для запросов из документации, реализовать используемые заголовки запросов, тела запросов и все сущности предметной области в виде кода и решить проблему сериализации для этих классов.
2. Воспользоваться существующим решением, которое позволяет работать с API.
Хотя первое решение является наиболее гибким в решении поставленной задачи, его реализация это достаточно трудоемкий процесс, поэтому было принято решение воспользоваться существующей библиотекой - bigbone. Библиотека обладает рядом преимуществ: 
1. Открытый исходный код
2. Активное сообщество разработчиков
3. Проработанность

## 5.2. Особенности реализации клиента

В целом, реализация клиента достаточно стандартна, поэтому обозначим только следующие, наиболее важные детали:
1. Интерфейс `IMastodon`
2. Кеширование данных авторизации

Для удобства разработки и отладки был создан интерфейс `IMastodon`, который, фактически, отражает в себе все варианты использования с некоторыми дополнениями:

```kotlin
interface IMastodon {
    fun getRules(): String
    fun register(username: String, email: String, password: String, agreement: Boolean, locale: String, autologin: Boolean = true, reason: String? = null)
    fun login(username: String, password: String)
    fun logout()
    fun getHomeTimeline(): Pageable<Status>
    fun getPublicTimeline(): Pageable<Status>
    fun searchUser(query: String): List<Account>
    fun getUserByUsername(username: String, hostname: String? = null): Account?
    fun getMe(): Account
    fun postStatus(text: String)
    fun scheduleStatusAfterDelay(text: String, delayPattern: String)
}
```

![[IMastodon-diagram.png]]

Во-первых, в документации Mastodon настоятельно рекомендуется перед регистрацией показывать пользователю правила инстанса на котором он хочет зарегистрироватся, этому соответствует метод `getRules(): String`

Во-вторых, для улучшения пользовательского опыта, при регистрации можно указать параметр `autologin: Boolean`, который, если пользователь захочет, автоматически авторизует приложение после регистрации.

Для удобства разработки, помимо основной реализации интерфейса в виде класса `Mastodon` был так же реализован класс `MastodonStub`, который не производит запросов к сервисам Mastodon, а лишь возвращает заранее определенные данные "заглушки". Это позволяет ускорить и упростить процесс разработки пользовательского интерфейса, так как убирает издержки в виде времени запроса/ответа с сервера и ошибки при указании неверных параметров.


Для того, чтобы сделать процесс взаимодействия клиента с сервисами Mastodon еще более эффективным, был создан интерфейс `IStorage`, который предназначен для кеширования данных для авторизации.

```kotlin
interface IStorage {
    fun getApplication(serverId: String): Application?
    fun saveApplication(serverUrl: String, app: Application)
    fun getRequestToken(clientId: String): Token?
    fun saveRequestToken(clientId: String, token: Token)
    fun getAccessToken(clientId: String, username: String): Token?
    fun saveAccessToken(clientId: String, username: String, token: Token)
}
```

![[IStorage-diagram.png]]

Это позволяет не делать повторные запросы при перезапуске приложения, что ускоряет время работы самого приложения и снижает нагрузку на сервис авторизации социальной сети.

## 5.3. Реализация пользовательского приложения

## 5.3.1. Архитектура

![[Layers-diagram.png]]

Архитектура приложения достаточно простая. Она представляет из себя, так называемую "слоистую" архитектуру, главной особенностью которой является разделение приложения на "слои" и их использование только в одном направлении: сверху вниз.

Слой storage отвечает за хранение данных для авторизации.
Слой client отвечает за взаимодействие с сервисами Mastodon.
Слои app и layouts предназначены для отображения функциональности слоя client на элементы пользовательского интерфейса платформы Luwrain.