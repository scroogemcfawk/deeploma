## 1. Социальная сеть Mastodon

### 1.1. Основная информация

Mastodon - это бесплатное программное обеспечение с открытым исходным кодом для запуска самостоятельных распределенных служб социальных сетей с функциями микроблогов. Mastodon входит состав Fediverse.

### 1.2. Основные понятия

Для того, чтобы лучше понять, что такое Mastodon, необходимо разобраться со следующими понятиями:
1. Распределенная социальная сеть
2. Fediverse
3. Микроблоггинг
4. Статус
5. Формат имен пользователей
6. Timeline

#### 1.2.1. Распределенная социальная сеть

Распределенная сеть представляет из себя совокупность независимых друг от друга серверов, которые могут физически находиться в разных местах. При этом, сервера сохраняют функциональную совместимость друг с другом. 

Фактически, они представляют из себя множество независимых вебсайтов, пользователи которых могут взаимодействовать друг с другом, как в пределах одного вебсайта, так и между ними. Например, как если бы я, имея аккаунт в социальной сети ВКонтакте, мог бы отправить сообщение пользователю социальной сети Одноклассники, не покидая сайт ВКонтакте. 

Администраторы узлов имеют власть только в пределах своего узла, а в случае несогласия пользователя с политикой администрации узла любой пользователь может присоединиться к другому уже существующему узлу социальной сети или даже развернуть собственный, который станет частью этой сети.

Все это, в отличие от централизованных социальных сетей, дает создаваемой узлами Mastodon сети быть неподконтрольной единственному хозяину.

Функциональную совместимость обеспечивает протокол ActivityPub, специально разработанный для распределенных социальных сетей. Тем не менее, каждый вебсайт Mastodon предоставляет доступ к своей функциональности по средствам REST API, что позволяет пользоваться всеми преимуществами ActivityPub используя только HTTP запросы. 

#### 1.2.2. Fediverse

Fediverse (от англ. **Fed**eration + Un**iverse**) - децентрализованное объединение социальных сетей, пользователи которых могут беспрепятственно общаться друг с другом. Сети, которые являются частью Fediverse, называются федеральными. 

Другими словами, если федеральная сеть (распределенная социальная сеть) это множество узлов социальной сети, то Fediverse - это множество этих множеств, причем пользователи из одного множества могут беспрепятственно взаимодействовать с пользователями из других множеств.

Сбор сообщений в Mastodon происходит в локальной и федеративной лентах. Локальная лента показывает сообщения пользователей единственного узла, тогда как федеративная лента делает это для всех известных узлов Fediverse.

#### 1.2.3. Микроблоггинг

Микроблоггинг - разновидность блогинга. Позволяет пользователям писать короткие заметки и публиковать их. Каждое такое сообщение может быть просмотрено и прокомментировано в режиме чата либо кем угодно, либо ограниченной группой лиц, которые могут быть выбраны пользователем. Примером социальной сети с такой функциональностью является X (ранее Twitter) (запрещенная в РФ)
Поэтому каждая заметка Mastodon имеет ограничение на количество символов.

#### 1.2.4. Статус

Хоть Mastodon и является социальной сетью, однако, в ней нет такого общепринятого понятия как сообщение. Вместо этого используется понятие статуса, или гудка, или тута (от англ. toot), по аналогии с твитом (от англ. tweet) из Twitter (запрещен в РФ). Пользователи могут опубликовать статус с различными ограничениями видимости, например: для всех; для всех, но и исключая из ленты рекомендаций; только для подписчиков; только для упомянутых в статусе пользователей. Это является важным элементом предметной области, хоть и не особо влияет на пользовательский опыт.
Статусы так же поддерживают функциональность хештегов, что позволяет пользователям искать статусы определенной категории, если они ими помечены. 
#### 1.2.5. Формат имен пользователей

Формат имен пользователей Mastodon похож на формат имен пользователей электронной почты. В начале имени идет идентификатор пользователя внутри вебсайта, а в конце, после знака '@', идет домен этого вебсайта. Тоесть, может возникнуть ситуация, когда имена пользователей совадают с точностью до адреса домена. Например: smf@mastodon.world и smf@techhub.social
При этом, в Mastodon присутствует соглашение, что в упоминаниях (идентификаторы, которые начинаются с префикса '@'), имя пользователя, в котором отсутствует логический адрес домена, разрешается до пользователя вебсайта, на котором он упоминается. Тоесть, если пользователь smf@techhub.social хочет упомянуть пользователя smf_dev@techhub.social, то ему достаточно написать '@smf_dev'.

#### 1.2.6. Timeline

Так как статусы могут принадлежать различным узлам федерации, их можно агрегировать в разные множества - timelines, или таймлайны. Таймлайн - это, по сути, аналог новостной ленты из привычных централизованных социальных сетей. 
По умолчанию разделяется три таймлайна:
1. Домашний
2. Локальный
3. Федеральный

К домашнему таймлайну относятся все статусы текущего пользователя. В локальный таймлайн попадают статусы всех пользователей вебсайта, на которм зарегистрирован текущий пользователь. В федеральный таймлайн попадают все остальные статусы федерации.

Следует обратить внимание, что локальный относится не к географическому местоположению, а только к вебсайту (серверу).

## 2. Платформа Luwrain

### 2.1 Основная информация

Luwrain - это платформа для построения невизуальных интерфейсов для слепых и слабовидящих людей с открытым исходным кодом.

Особенностью и отличительной чертой данной платформы является нативный невизуальный интерфейс. Компоненты платформы позволяют создать эффективно взаимодействовать с компьютером и обрабатывать ситуации, когда невозможно получить информацию с экрана в невизуальной форме. Это позволяет создать единый подход к работе над задачами любого рода, а следовательно выработать ряд привычек, которые помогают определить порядок действий в той или иной ситуации без необходимости прибегать к документации.

В основе данного похода лежит идея невизуального дизайна. Она заключается в том, чтобы как можно сильнее снизить издержки взаимодействия пользователя с системой. Это достигается наличием текстового представления у каждого элемента интерфейса, которое отображается на экране (эта возможность сохранена для слабовидящих пользователей). Текстовая информация, в свою очередь, воспроизводится в виде звука при помощи синтезатора речи. Эта функция поддерживается повсеместно. При этом, есть два режима воспроизведения:
1. Воспроизведение при интерактивном взаимодействии;
   Данное режим представляет из себя более точное воспроизведение текста и подходит для навигации. 
2. Воспроизведение для прослушивания.
   Данный режим приближен к естественной речи и подходит для прослушивания текстов и книг.

### 2.2 Расширения

Платформа спроектирована таким образом, что использование ее компонент не вызывает затруднений и позволяет любому пользователю легко создать собственное приложение с необходимой ему функциональностью. Это возможно при помощи так называемых "расширений". Фактически, расширение представляет из себя реализацию интерфейса `org.luwrain.core.Extension` или `org.luwrain.core.EmptyExtension`, который создан для удобства и позволяет добавить только необходимые функции.
Расширения бывают двух типов:
1. Расширения, скомпилированные в виде jar файла;
   Большая часть расширений написана на Java, в данной работе реализация будет написана на Kotlin, так же, предполагается возможность написания расширений на Scala и Groovy, однако это не проверялось.
2. Расширения, написанные на JavaScript.
Так же, расширения делятся на две категории:
1. Системные;
   Доверенные расширения из состава дистрибутива.
2. Пользовательские.
   Так как пользовательские расширения могут быть получены из непроверенных источников для них в системе присутствуют механизмы ограничений.

При загрузке платформа LUWRAIN самостоятельно создаст экземпляр класса расширения и запросит необходимое множество объектов для интеграции.
В дистрибутивах LUWRAIN присутствуют два каталога расширений: jar и lib. При запуске системы содержимое этих каталогов сканируется и все файлы с расширением .jar. Подразумевается, что в каталоге `jar` находятся файлы, которые собраны из исходных текстов проекта, а в `lib` присутствуют сторонние библиотеки, полученные от других разработчиков в виде бинарных файлов.

При обработке каждого файла с расширением `.jar` проверяется наличие секции `org/luwrain` в его манифесте. Если в этой секции есть значение `Extensions`, то предполагается, что оно содержит список классов, удовлетворяющих интерфейсу `org.luwrain.core.Extension`, каждый из которых воспринимается как класс расширения для загрузки. Если такое значение в манифесте отсутствует, то файл загружается просто как вспомогательная библиотека, классы которой будут доступны другим библиотекам.

Обратите внимание, что порядок членов манифеста в таких системах сборки как Apache Maven и Gradle может отличаться от указанного выше. Это обусловлено тем, что в их реализации используется HashMap, а не LinkedHashMap, что может нарушать необходимый порядок и ваше расширение распознается некорректно и будет загружено, как библиотека. Если вы столкнулись с такой проблемой, то одним из ее решений может использование системы сборки Ant. \[Dev. 3\]

В файле конфигурации сборки Ant, build.xml, необходимо указать следующие параметры в target, который собирает jar файл:
```xml
<jar jarfile="jar/your-app.jar">
	<manifest>
		<section name="org/luwrain">
			<attribute name="Extensions" value="path.to.Extension"/>
		</section>
	</manifest>
    ...
</jar>
```

### 2.3 Получение дистрибутива

#### 2.3.1. Виды дистрибутивов

На текущий момент поддерживается несколько дистрибутивов:
1. Приложение для Microsoft Windows;
2. Приложение для GNU/Linux;
3. Приложение для Raspberry Pi;
4. В виде ISO образа операционной системы на базе ядра Linux. 
#### 2.3.2. Получение дистрибутива

Выделяется два основных метода получения дистрибутива данной платформы:
1. В виде собранного пакета с официального сайта 
2. Из исходных текстов
##### 2.3.2.1. Получение с официального сайта

Для этого необходимо перейти по ссылке: https://luwrain.org/download/?lang=ru&mode=normal
На странице доступно несколько разделов для загрузки необходимого дистрибутива.
##### 2.3.2.2. Получение из исходных текстов и сборка

Исходный текст можно найти по ссылке: https://github.com/luwrain/parent
Для того, чтобы загрузить исходные тексты на свой компьютер, необходимо выполнить команду: 
```sh
git clone --recursive https://github.com/luwrain/parent.git
```
Обратите внимание, так как проект разделен на несколько репозиториев, необходимо указать флаг `--recursive`, чтобы заргузить код из дочерних репозиториев. Так же, предполагается, что в вашей системе доступна команда git (для дистрибутивов Linux доступна по умолчанию, для Windows придется произвести загрузку из интернета).

Для того, чтобы собрать проект, необходимо, чтобы в вашей системе были установлены:
1. JRE версии 17 SE и выше;
2. Система сборки Apache Maven;
3. Система сборки Apache Ant.

Для сборки необходимо выполнить следующие команды:
```sh
cd parent/base/scripts
./lwr-ant-gen-all
./lwr-build
```

Так же, для ускорения сборки, можно отключить тестирование и генерацию документации. Для этого в той же директории в файле `lwr-build-mvn`, в строке `mvn install -B -C -q` можно добавить флаги `-DskipTests=true` и `-Dmaven.javadoc.skip=true`, а так же закоментировать строку `mv jar/*javadoc*.jar javadoc`

### 2.4. Разработка

Для разработки рекомендуется скачать дистрибутив с официального сайта и исходные тексты платформы. Наличие исходных текстов позволит, при необходимости, оперативно найти места, которые могут вызывать затруднения и, зачастую, быстро найти решение.

Перед, непосредственно, разработкой, необходимо создать модуль приложения и подключить его к parent. Для этого необходимо:
1. Создать директорию вашего приложения в parent с префиксом `app-`, например, `app-mastodon`
2. Добавить `pom.xml` в получившуюся в п.1 директорию
3. В `parent/pom.xml`, в теге `<modules>` добавить модуль приложения
```xml
<modules>
	...
	<module>app-mastodon</module>
</modules>
```

Для использования компонент Luwrain в вашем приложении, необходимо в `pom.xml` вашего приложения добавить зависимость:
```xml
<dependencies>
	...
	<dependency>
		<groupId>org.luwrain</groupId>
		<artifactId>luwrain</artifactId>
		<version>${luwrain.version}</version>
	</dependency>
</dependencies>
```
Так как в данный момент API Luwrain нестабилен и он намеренно не загружается в основной репозиторий Maven, необходимо так же подключить репозиторий Luwrain:
```xml
<repositories>
	...
	<repository>
		<id>luwrain</id>
		<name>luwrain</name>
		<url>https://download.luwrain.org/maven2/</url>
	</repository>
</repositories>
```

При сборке необходимо добавить название вашего приложения в `parent/base/scripts/config.sh` в переменную `APPS` через пробел, без префикса `app-`:
```sh
...
APPS='commander contacts main news notepad telegram viewer vk mastodon'
...
```

В процессе разработки, после компиляции приложения, его необходимо поместить в директорию `lib` скачанного дистрибутива. 
Удобно использовать символьные ссылки, что бы экономить время на копировании `jar` файлов:
```sh
cd lib
ln -sf /path/to/app-mastodon.jar app-mastodon.jar
```
Флаг `-s` создаст символьную ссылку, а `-f` перезапишет ее, если она существовала.

Так как весь код платформы на данный момент написан на языке Java, то необходимо внести следующие изменения в файл сборки Apache Ant. Он генерируется автоматически скриптом parent/base/scripts/lwr-ant-gen-app. После генерации этого файла
1. Необходимо скачать `kotlin-ant.jar` по ссылке https://github.com/JetBrains/kotlin/releases/tag/v1.9.24
2. В файле `build.xml` вашего приложения добавить плагин Ant:
```xml
<typedef 
	resource="org/jetbrains/kotlin/ant/antlib.xml"
	classpath="/path/to/kotlin-ant.jar"
/>
```
3. В `compile` к телу команды `javac` добавить тег `<withKotlin/>`, чтобы он лежал после тегов `<compilerarg .../>`
4. Так как исходный код Kotlin обычно располагается отдельно от Java, нужно добавить его на вход компилятора. Для этого нужно поменять параметр `srcdir` в  `compile` с `src/main/java` на `src/main`, так как директории `java` и `kotlin` лежат в одном месте

## 3. OAuth

Так как Mastodon является социальной сетью, то ограничения доступа к ресурсам и выдача прав на доступ к ним встают особенно остро. В Mastodon для решения этих задач используется технология OAuth версии 2.0.

OAuth 2.0 - протокол авторизации, позволяющий выдать одному сервису права на доступ к ресурсам пользователя на другом сервисе. Протокол избавляет от необходимости доверять приложению логин и пароль, а также позволяет выдавать ограниченный набор прав.

OAuth 2.0 основан на использовании базовых веб-технологий: HTTP-запросах, редиректах и т.п. Поэтому его использование возможно на любой платформе с доступом к интернету.  
  
Общая схема работы приложения, использующего OAuth, такова:  
1. получение авторизации
2. обращение к защищенным ресурсам

Результатом авторизации является access token - некоторый ключ (набор символов), предъявление которого является пропуском к защищенным ресурсам. Обращение к ним в самом простом случае происходит по HTTPS с указанием в заголовках полученного access token'а.

В протоколе описано несколько вариантов авторизации (так называемых workflow), подходящих для различных ситуаций:
* авторизация для приложений, имеющих серверную часть (чаще всего, это сайты и веб-приложения)
* авторизация для полностью клиентских приложений (мобильные и desktop-приложения)
* авторизация по логину и паролю
* восстановление предыдущей авторизации

И, хоть протокол это и позволяет, в нашем случае использовать варианты авторизации, кроме как по логину и паролю не имеет особого смысла, так как предполагается, что разрабатываемое приложение хранит информацию и исполняется локально, на системе пользователя.

Обратите внимание, что для повышения эффективности работы с OAuth имеет смысл сохранять полученные от сервиса авторизации данные локально (кешировать). Это позволит не делать лишних запросов, чтобы получить полученную ранее информацию, а значит ускорить взаимодействие пользователя с приложением.

## 4. Визуальные клиенты социальной сети

Очевидно, что так как в проекте LUWRAIN нет пакета с расширением Mastodon, то аналогов разрабатываемой системы не существует. 

Несмотря на это, можно изучить готовые решения как реализованных с упором на графический пользовательский интерфейс (GUI – Graphical User Interface), так и решения с текстовым интерфейсом, такие как CLI (Command Line Interface) и TUI (Terminal User Interface), чтобы определить ключевые элементы пользовательского опыта. 

### 4.1. Веб приложение Mastodon (GUI)

По умолчанию, любой узел Mastodon предоставляет доступ к приложению в виде веб-страницы, где пользователь может выполнять все функции, предоставляемые пользователю социальной сетью.

На одном экране располагается множество различных элементов:
1. Строка поиска
2. Краткая информация о пользователе, с возможностью перехода на страницу настроек
3. Область создания статуса с полем для текста и различными параметрами
4. Область таймлайна
5. Область переключения между таймлайнами
6. Кнопка перехода на страницу настроек

### 4.2. toot

toot - это клиент Mastodon с открытым исходным кодом, написанный на Python. toot предоставляет пользователю пользоваться своими функциями как в CLI режиме, так и в режиме TUI.

#### 4.2.1. CLI

В режиме CLI toot позволяет выполнить желаемое действие в виде команды, например, так выглядит команда, которая показывает информацию о пользователе:
```sh
toot whois smf
```
Результат:
```
@smf Stepan Bylkov

Developer at Tomsk State University
#TSU #LUWRAIN

ID: 112337283650520914
Since: 2024-04-26

Followers: 0
Following: 0
Statuses: 3

https://techhub.social/@smf
```

Обратите внимание, что здесь не указан домен пользователя, поэтому будет показана информация о пользователе на том же вебсайте, по которому зарегистрирован текущий пользователь.

#### 4.2.2. TUI

В режиме TUI доступен "плиточный" интерфейс, который свойственен приложениям с таким интерфейсом и, вобщем то, напоминает интерфейс Luwrain. 

Он состоит из двух "плиток", слева находятся статусы текущего таймлайна, справа контент и информация о выбранном статусе. 
Навигация по статусам одного таймлайна и между таймлайнами происходит с помощью горящих клавиш.

Так же, хоть Mastodon допускает просматривание таймлайнов без необходимости авторизации клиента (т.е. при помощи Request Token приложения), в toot такой режим использования не допускается.

Однако у данного приложения имеется один значительный недостаток: оно не реализует функции регистрации. Вместо этого, подразумевается, что пользователь уже имеет аккаунт на каком-либо вебсайте и для того, чтобы авторизовать приложение необходимо перейти по ссылке, которую генерирует клиент, чтобы получить Access Token. Это является критическим недостатком в ситуации, когда необходимо выполнить регистрацию и авторизацию без использования каких-либо визуальных интерфейсов.

### 4.3. Megalodon (GUI)

Megalodon - мобильный клиент Mastodon. Интерфейс выделяет области таймлайна, поиска, уведомлений и профиля. 

В области таймлайна доступно переключение между таймлайнами. 

В области поиска доступен поиск по хештегам, статусам, новостям и рекомендациям.

Уведомления делятся на все и упоминания.

В профиле доступена информация о пользователе, включая статусы домашнего таймлайна, настройки профиля, а так же списки, избранное и хэштеги, на которые подписан пользователь.


Исходя из реализации вышеперечисленных клиентов, можно выделить основные элементы интерфейса:
1. Область таймлайна
2. Область подробной информации об элементе
3. Область навигации

